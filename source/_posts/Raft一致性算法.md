
---
title: "Raft一致性算法"
catalog: true
toc_nav_num: true
date: 2019-01-23 12:49:24
subtitle: "etcd核心思想"
header-img: "/img/header_img/archive-bg.png"
tags:
- etcd
catagories:
- etcd

---

#### 一、一致性

##### 1. 是什么一致性
对于分布式系统的一致性问题，是指对于一组服务器，当给出一组操作时，使用某种协议使最后所有服务器的结果一致。
2. 如何保证一致性
    * **CAP理论**：对于分布式计算机系统，不能同时满足以下三点，一致性、可用性、分区容错性
    * **几种一致性模型**：强一致性、弱一致性、最终一致性
    * **强一致性实现原理**：我们讨论的raft算法是强一致性，某台服务器收到一组指令，同其他的服务器交流，保证素有服务器以同样的顺序收到指令，以此保证整组服务器最终产生的结果一致
    
#### 二、Raft

##### 1.问题分解：

     raft算法实现一致性，主要有以下几个方面，领导选举、日志复制、安全、成员变化

##### 2.基本概念
   
   * **复制状态机**：当大多数的机器上日志相同时，即为提交至状态机
   * **服务器状态**：领导者、候选人、追随者
   * **任期**：raft算法将时间划分成任意不同长度的任期，使用连续的数字表示，任期以选举作为开始，每个任期最多一个领导人
   * **RPC**：服务器之间通信方式，包括三种：选举rpc、心跳rpc、******，超时设置：领导人心跳超时时间、候选超时时间、单个服务器发生故障平均间隔
    
3.哪些操作

   * **领导人选举**
       **a.触发条件**：领导者故障、追随者没有接收到心跳，选举超时时间不会清零，发生选举超时，追随者变成候选者
       **b.过程**： 追随者自增当前任期，变为候选人 |  给自己投票 | 发起选举rpc |获得超半数投票，成为领导者 | 或收到其他领导者的心跳，成为追随者 | 选举超时，下一轮选举
       **c.选举原则**：一次选举投一票 | 候选者等待投票，获得领导人的心跳，若其任期小于本轮任期，拒绝该rpc | 防止无限选举，使用的随机的选举超时时间
  
   * 日志复制
       **a.接受命令的过程**：领导者接收到命令，发送心跳给追随者，收到大多数确认后，提交日志到状态机，并返回结果给客户端
       **b.提交命令的过程**：下一个阶段，领导者再次发送心跳，追随者接受日志已经提交，将日志在状态机回放
   * 安全性保证
       **a.领导者追加日志**：不会覆盖之前的条目，从领导者到追随者
       **b.选举限制**：投票阻止没有全部日志条目的服务器赢得选举，及选举过程中，候选者的日志条目比大多数的服务器新，才可能赢得选举
       **c.不提交任期之前的日志条目**
       **d.候选者和追随者崩溃**：无限重试
   * 集群成员变更
       **保证安全**：集群先切换到一个过渡的配置，称为共同一致；一旦共同一致已经被提交了，那么系统就切换到新的配置上。共同一致是老配置和新配置的结合，只有拥有 C-old,new 日志条目的服务器才有可能被选举为领导人；
   
   
资料：**Raft动画展示**：http://thesecretlivesofdata.com/raft/
    **Raft Web site**：https://raft.github.io

 